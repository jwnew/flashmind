<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FlashMind ‚Äî Study Cards</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0e0e12;
    --surface: #16161e;
    --surface2: #1e1e2a;
    --border: #2a2a3a;
    --accent: #e8c547;
    --accent2: #7c5cbf;
    --text: #f0f0f8;
    --muted: #7a7a9a;
    --green: #4ade80;
    --red: #f87171;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: radial-gradient(ellipse at 20% 10%, rgba(124,92,191,0.15) 0%, transparent 50%),
                      radial-gradient(ellipse at 80% 80%, rgba(232,197,71,0.08) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
  }

  .app { position: relative; z-index: 1; max-width: 900px; margin: 0 auto; padding: 2rem 1.5rem; }

  /* LOGIN */
  .login-wrap {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    z-index: 1;
  }
  .login-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 2.5rem;
    width: 100%;
    max-width: 380px;
    text-align: center;
  }
  .login-logo { font-family: 'Plus Jakarta Sans', sans-serif; font-size: 2rem; font-weight: 800; letter-spacing: -0.03em; margin-bottom: 0.4rem; }
  .login-logo span { color: var(--accent); }
  .login-sub { color: var(--muted); font-size: 0.9rem; margin-bottom: 2rem; line-height: 1.5; }
  .login-box label { display: block; font-size: 0.8rem; color: var(--muted); text-align: left; margin-bottom: 0.4rem; letter-spacing: 0.05em; text-transform: uppercase; }
  .login-box input {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 1rem;
    padding: 0.75rem 1rem;
    outline: none;
    transition: border-color 0.2s;
    margin-bottom: 1.2rem;
  }
  .login-box input:focus { border-color: var(--accent); }
  .login-btn {
    width: 100%;
    background: var(--accent);
    color: #000;
    border: none;
    border-radius: 10px;
    padding: 0.85rem;
    font-family: 'DM Sans', sans-serif;
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  .login-btn:hover { background: #f0d060; }
  .login-note { margin-top: 1.2rem; font-size: 0.78rem; color: var(--muted); line-height: 1.5; }

  /* HEADER */
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 2.5rem;
    flex-wrap: wrap;
    gap: 0.75rem;
  }
  .logo { font-family: 'Plus Jakarta Sans', sans-serif; font-size: 1.8rem; font-weight: 800; letter-spacing: -0.03em; }
  .logo span { color: var(--accent); }
  .header-right { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; }
  .user-badge { font-size: 0.8rem; color: var(--muted); background: var(--surface2); border: 1px solid var(--border); border-radius: 100px; padding: 0.35rem 0.85rem; }
  .user-badge strong { color: var(--accent); }

  .nav-pills { display: flex; gap: 0.5rem; }
  .pill-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--muted);
    padding: 0.45rem 1rem;
    border-radius: 100px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }
  .pill-btn:hover, .pill-btn.active { background: var(--accent); color: #000; border-color: var(--accent); }
  .pill-btn.logout:hover { background: rgba(248,113,113,0.15); color: var(--red); border-color: var(--red); }

  /* SYNC BAR */
  .sync-bar { display: flex; align-items: center; gap: 0.5rem; font-size: 0.78rem; color: var(--muted); margin-bottom: 1.2rem; height: 20px; }
  .sync-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--muted); flex-shrink: 0; }
  .sync-dot.ok { background: var(--green); }
  .sync-dot.saving { background: var(--accent); animation: pulse 1s infinite; }
  .sync-dot.error { background: var(--red); }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

  /* VIEWS */
  .view { display: none; }
  .view.active { display: block; }

  /* DECKS */
  .section-title { font-family: 'Plus Jakarta Sans', sans-serif; font-size: 1.4rem; font-weight: 700; margin-bottom: 1.2rem; }
  .decks-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
  .deck-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 1.4rem;
    cursor: pointer;
    transition: all 0.25s;
    position: relative;
    overflow: hidden;
  }
  .deck-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: var(--accent); transform: scaleX(0); transition: transform 0.25s; transform-origin: left; }
  .deck-card:hover { border-color: var(--accent); transform: translateY(-3px); box-shadow: 0 12px 30px rgba(0,0,0,0.4); }
  .deck-card:hover::before { transform: scaleX(1); }
  .deck-name { font-weight: 600; font-size: 1rem; margin-bottom: 0.4rem; line-height: 1.3; }
  .deck-count { font-size: 0.8rem; color: var(--muted); }
  .deck-actions { display: flex; gap: 0.4rem; margin-top: 1rem; }
  .btn-sm {
    flex: 1; padding: 0.35rem 0.5rem; border-radius: 8px; border: 1px solid var(--border);
    background: transparent; color: var(--muted); font-size: 0.75rem;
    font-family: 'DM Sans', sans-serif; cursor: pointer; transition: all 0.2s; text-align: center;
  }
  .btn-sm:hover { background: var(--surface2); color: var(--text); }
  .btn-sm.danger:hover { background: rgba(248,113,113,0.15); color: var(--red); border-color: var(--red); }
  .btn-sm.primary:hover { background: rgba(232,197,71,0.15); color: var(--accent); border-color: var(--accent); }

  .add-deck-card {
    background: transparent; border: 2px dashed var(--border); border-radius: 16px; padding: 1.4rem;
    cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center;
    gap: 0.5rem; color: var(--muted); transition: all 0.2s; min-height: 110px;
  }
  .add-deck-card:hover { border-color: var(--accent); color: var(--accent); }
  .add-icon { font-size: 1.8rem; line-height: 1; }

  /* CREATE/EDIT */
  .back-btn {
    display: inline-flex; align-items: center; gap: 0.4rem; background: transparent; border: none;
    color: var(--muted); font-family: 'DM Sans', sans-serif; font-size: 0.9rem; cursor: pointer;
    margin-bottom: 1.5rem; padding: 0; transition: color 0.2s;
  }
  .back-btn:hover { color: var(--text); }
  .field-group { margin-bottom: 1.2rem; }
  label { display: block; font-size: 0.8rem; color: var(--muted); margin-bottom: 0.4rem; letter-spacing: 0.05em; text-transform: uppercase; }
  input[type="text"], textarea {
    width: 100%; background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
    color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 0.95rem;
    padding: 0.7rem 1rem; outline: none; transition: border-color 0.2s;
  }
  input[type="text"]:focus, textarea:focus { border-color: var(--accent); }
  textarea { resize: vertical; min-height: 80px; }
  .cards-list { display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.5rem; }
  .card-item { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 1.2rem; position: relative; }
  .card-num { font-size: 0.75rem; color: var(--muted); margin-bottom: 0.8rem; font-weight: 600; letter-spacing: 0.05em; }
  .card-fields { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
  @media (max-width: 600px) { .card-fields { grid-template-columns: 1fr; } }
  .remove-card-btn { position: absolute; top: 0.8rem; right: 0.8rem; background: transparent; border: none; color: var(--muted); font-size: 1.1rem; cursor: pointer; transition: color 0.2s; line-height: 1; }
  .remove-card-btn:hover { color: var(--red); }

  .btn-primary { background: var(--accent); color: #000; border: none; border-radius: 10px; padding: 0.75rem 1.5rem; font-family: 'DM Sans', sans-serif; font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: all 0.2s; }
  .btn-primary:hover { background: #f0d060; transform: translateY(-1px); }
  .btn-outline { background: transparent; color: var(--text); border: 1px solid var(--border); border-radius: 10px; padding: 0.75rem 1.5rem; font-family: 'DM Sans', sans-serif; font-weight: 500; font-size: 0.95rem; cursor: pointer; transition: all 0.2s; margin-right: 0.75rem; }
  .btn-outline:hover { border-color: var(--text); }

  /* STUDY */
  .study-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 2rem; }
  .progress-bar-wrap { flex: 1; height: 6px; background: var(--surface2); border-radius: 100px; margin: 0 1.5rem; overflow: hidden; }
  .progress-bar-fill { height: 100%; background: var(--accent); border-radius: 100px; transition: width 0.4s ease; }
  .progress-text { font-size: 0.85rem; color: var(--muted); white-space: nowrap; }

  .flashcard-scene { perspective: 1200px; width: 100%; max-width: 600px; margin: 0 auto 2rem; height: 320px; }
  .flashcard { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.4,0,0.2,1); cursor: pointer; }
  .flashcard.flipped { transform: rotateY(180deg); }
  .card-face { position: absolute; inset: 0; border-radius: 24px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2.5rem; backface-visibility: hidden; -webkit-backface-visibility: hidden; }
  .card-front { background: var(--surface); border: 1px solid var(--border); }
  .card-back { background: linear-gradient(135deg,#1a1a28,#1e1830); border: 1px solid var(--accent2); transform: rotateY(180deg); }
  .card-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.15em; color: var(--muted); margin-bottom: 1rem; font-weight: 600; }
  .card-back .card-label { color: rgba(124,92,191,0.8); }
  .card-text { font-family: 'Plus Jakarta Sans', sans-serif; font-size: clamp(1.1rem,3vw,1.6rem); font-weight: 600; text-align: center; line-height: 1.5; white-space: pre-wrap; }
  .card-back .card-text { color: #c8b4f0; }
  .flip-hint { font-size: 0.78rem; color: var(--muted); margin-top: 1.5rem; }

  .study-controls { display: flex; justify-content: center; align-items: center; gap: 1rem; margin-bottom: 2rem; }
  .ctrl-btn { width: 52px; height: 52px; border-radius: 50%; border: 1px solid var(--border); background: var(--surface); color: var(--text); font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
  .ctrl-btn:hover { border-color: var(--text); transform: scale(1.05); }
  .ctrl-btn.correct { border-color: var(--green); color: var(--green); }
  .ctrl-btn.correct:hover { background: rgba(74,222,128,0.1); }
  .ctrl-btn.wrong { border-color: var(--red); color: var(--red); }
  .ctrl-btn.wrong:hover { background: rgba(248,113,113,0.1); }
  .flip-btn { padding: 0.7rem 2rem; background: var(--surface2); border: 1px solid var(--border); color: var(--text); border-radius: 100px; font-family: 'DM Sans', sans-serif; font-weight: 500; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; }
  .flip-btn:hover { border-color: var(--accent); color: var(--accent); }

  .results-wrap { text-align: center; padding: 3rem 1rem; }
  .results-title { font-family: 'Plus Jakarta Sans', sans-serif; font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem; }
  .results-score { font-size: 4rem; font-weight: 700; color: var(--accent); line-height: 1; margin: 1rem 0; }
  .results-sub { color: var(--muted); margin-bottom: 2rem; }
  .results-bars { display: flex; justify-content: center; gap: 1.5rem; margin-bottom: 2rem; }
  .result-pill { padding: 0.5rem 1.2rem; border-radius: 100px; font-size: 0.9rem; font-weight: 600; }
  .result-pill.g { background: rgba(74,222,128,0.15); color: var(--green); }
  .result-pill.r { background: rgba(248,113,113,0.15); color: var(--red); }

  .empty { text-align: center; padding: 4rem 2rem; color: var(--muted); }
  .empty-icon { font-size: 3rem; margin-bottom: 1rem; }

  .spinner { width: 36px; height: 36px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.7s linear infinite; margin: 3rem auto; }
  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
  .view.active { animation: fadeIn 0.3s ease; }
  .deck-card { animation: fadeIn 0.3s ease both; }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen" class="login-wrap">
  <div class="login-box">
    <div class="login-logo">Flash<span>Mind</span></div>
    <div class="login-sub">Choose a username to sync your decks across all your devices automatically.</div>
    <label for="username-input">Username</label>
    <input type="text" id="username-input" placeholder="e.g. sarah123" autocomplete="off" autocapitalize="none"
      onkeydown="if(event.key==='Enter')login()" />
    <button class="login-btn" onclick="login()">Continue ‚Üí</button>
    <div class="login-note">‚ö†Ô∏è Your username acts as your key ‚Äî pick something unique that only you'd guess. Anyone with your username can access your decks.</div>
  </div>
</div>

<!-- MAIN APP -->
<div id="main-app" style="display:none">
  <div class="app">
    <header>
      <div class="logo">Flash<span>Mind</span></div>
      <div class="header-right">
        <div class="user-badge">Signed in as <strong id="user-display"></strong></div>
        <div class="nav-pills">
          <button class="pill-btn active" onclick="showView('decks')">My Decks</button>
          <button class="pill-btn" onclick="startCreate()">+ New Deck</button>
          <button class="pill-btn logout" onclick="logout()">Sign Out</button>
        </div>
      </div>
    </header>

    <!-- DECKS VIEW -->
    <div id="view-decks" class="view active">
      <div class="sync-bar">
        <div class="sync-dot" id="sync-dot"></div>
        <span id="sync-label">Connecting...</span>
      </div>
      <div class="section-title">Your Study Decks</div>
      <div class="decks-grid" id="decks-grid"><div class="spinner"></div></div>
    </div>

    <!-- CREATE/EDIT VIEW -->
    <div id="view-create" class="view">
      <button class="back-btn" onclick="showView('decks')">‚Üê Back to Decks</button>
      <div class="section-title" id="create-title">Create New Deck</div>
      <div class="field-group">
        <label>Deck Name</label>
        <input type="text" id="deck-name-input" placeholder="e.g. Spanish Vocabulary" />
      </div>
      <div class="section-title" style="margin-top:1.5rem;margin-bottom:1rem;font-size:1.1rem;">Cards</div>
      <div class="cards-list" id="cards-list"></div>
      <button class="btn-outline" onclick="addCardField()">+ Add Card</button>
      <button class="btn-primary" onclick="saveDeck()">Save Deck</button>
    </div>

    <!-- STUDY VIEW -->
    <div id="view-study" class="view">
      <div class="study-header">
        <button class="back-btn" onclick="showView('decks')" style="margin:0">‚Üê Exit</button>
        <div class="progress-bar-wrap">
          <div class="progress-bar-fill" id="progress-fill" style="width:0%"></div>
        </div>
        <div class="progress-text" id="progress-text">0 / 0</div>
      </div>
      <div id="study-content"></div>
    </div>
  </div>
</div>

<script>
  let currentUser = null;
  let decks = [];
  let editingDeckId = null;
  let studyDeck = null;
  let studyIndex = 0, studyCorrect = 0, studyWrong = 0;
  let isFlipped = false;
  let saveTimeout = null;

  // ---- AUTH ----
  function login() {
    const raw = document.getElementById('username-input').value.trim().toLowerCase();
    const val = raw.replace(/[^a-z0-9_\-]/g, '');
    if (!val || val.length < 2) {
      alert('Please enter a username (at least 2 characters, letters/numbers/_ or - only).');
      return;
    }
    currentUser = val;
    localStorage.setItem('flashmind_user', currentUser);
    bootApp();
  }

  function logout() {
    localStorage.removeItem('flashmind_user');
    currentUser = null; decks = [];
    document.getElementById('main-app').style.display = 'none';
    document.getElementById('login-screen').style.display = 'flex';
    document.getElementById('username-input').value = '';
  }

  function bootApp() {
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('main-app').style.display = 'block';
    document.getElementById('user-display').textContent = currentUser;
    loadDecks();
  }

  // ---- CLOUD STORAGE ----
  function storageKey() { return 'decks:' + currentUser; }

  function setSyncStatus(state, msg) {
    const dot = document.getElementById('sync-dot');
    const label = document.getElementById('sync-label');
    if (!dot) return;
    dot.className = 'sync-dot ' + state;
    label.textContent = msg;
  }

  async function loadDecks() {
    setSyncStatus('saving', 'Loading your decks...');
    try {
      const result = await window.storage.get(storageKey());
      decks = result ? JSON.parse(result.value) : [];
      setSyncStatus('ok', 'Synced ¬∑ ' + new Date().toLocaleTimeString());
    } catch(e) {
      decks = [];
      setSyncStatus('ok', 'Ready ‚Äî create your first deck!');
    }
    renderDecks();
    checkLocalMigration();
  }

  function checkLocalMigration() {
    const local = localStorage.getItem('flashmind_decks');
    if (!local) return;
    try {
      const localDecks = JSON.parse(local);
      if (!localDecks || localDecks.length === 0) return;
      const banner = document.createElement('div');
      banner.id = 'migrate-banner';
      banner.style.cssText = 'background:linear-gradient(135deg,#1e1e2a,#1a1a28);border:1px solid var(--accent);border-radius:14px;padding:1rem 1.2rem;margin-bottom:1.2rem;display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;animation:fadeIn 0.3s ease;';
      banner.innerHTML = `
        <div>
          <div style="font-weight:600;font-size:0.95rem;margin-bottom:0.2rem;">üì¶ Found ${localDecks.length} deck${localDecks.length !== 1 ? 's' : ''} saved on this device</div>
          <div style="font-size:0.8rem;color:var(--muted);">Import them into your cloud profile so they sync everywhere.</div>
        </div>
        <div style="display:flex;gap:0.5rem;flex-shrink:0">
          <button onclick="migrateLocalDecks()" style="background:var(--accent);color:#000;border:none;border-radius:8px;padding:0.5rem 1rem;font-family:'DM Sans',sans-serif;font-weight:600;font-size:0.85rem;cursor:pointer;">Import Now</button>
          <button onclick="dismissMigration()" style="background:transparent;color:var(--muted);border:1px solid var(--border);border-radius:8px;padding:0.5rem 0.75rem;font-family:'DM Sans',sans-serif;font-size:0.85rem;cursor:pointer;">Dismiss</button>
        </div>`;
      const grid = document.getElementById('decks-grid');
      grid.parentNode.insertBefore(banner, grid);
    } catch(e) { /* ignore */ }
  }

  async function migrateLocalDecks() {
    const local = localStorage.getItem('flashmind_decks');
    if (!local) return;
    try {
      const localDecks = JSON.parse(local);
      const existingNames = new Set(decks.map(d => d.name.toLowerCase()));
      let added = 0;
      localDecks.forEach(d => {
        if (!existingNames.has(d.name.toLowerCase())) {
          decks.push({ ...d, id: d.id || uid() });
          added++;
        }
      });
      await saveToCloud();
      localStorage.removeItem('flashmind_decks');
      document.getElementById('migrate-banner')?.remove();
      renderDecks();
      alert(`‚úÖ Done! ${added} deck${added !== 1 ? 's' : ''} imported to your cloud profile.${added < localDecks.length ? '\n(' + (localDecks.length - added) + ' skipped ‚Äî already existed in your profile)' : ''}`);
    } catch(e) {
      alert('Something went wrong during import. Please try again.');
    }
  }

  function dismissMigration() {
    document.getElementById('migrate-banner')?.remove();
    localStorage.removeItem('flashmind_decks');
  }

  async function saveToCloud() {
    setSyncStatus('saving', 'Saving...');
    try {
      await window.storage.set(storageKey(), JSON.stringify(decks));
      setSyncStatus('ok', 'Synced ¬∑ ' + new Date().toLocaleTimeString());
    } catch(e) {
      setSyncStatus('error', 'Sync failed ‚Äî check your connection');
    }
  }

  function scheduleSave() {
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(saveToCloud, 600);
  }

  // ---- VIEWS ----
  function showView(name) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById('view-' + name).classList.add('active');
    if (name === 'decks') renderDecks();
  }

  // ---- DECKS ----
  function renderDecks() {
    const grid = document.getElementById('decks-grid');
    grid.innerHTML = '';

    if (decks.length === 0) {
      grid.innerHTML = `<div class="empty" style="grid-column:1/-1"><div class="empty-icon">üìö</div><p>No decks yet. Create your first one!</p></div>`;
    } else {
      decks.forEach((deck, i) => {
        const d = document.createElement('div');
        d.className = 'deck-card';
        d.style.animationDelay = (i * 0.05) + 's';
        d.innerHTML = `
          <div class="deck-name">${esc(deck.name)}</div>
          <div class="deck-count">${deck.cards.length} card${deck.cards.length !== 1 ? 's' : ''}</div>
          <div class="deck-actions">
            <button class="btn-sm primary" onclick="event.stopPropagation();studyDeckById('${deck.id}')">Study</button>
            <button class="btn-sm" onclick="event.stopPropagation();editDeck('${deck.id}')">Edit</button>
            <button class="btn-sm danger" onclick="event.stopPropagation();deleteDeck('${deck.id}')">Delete</button>
          </div>`;
        d.addEventListener('click', () => studyDeckById(deck.id));
        grid.appendChild(d);
      });
    }

    const addBtn = document.createElement('div');
    addBtn.className = 'add-deck-card';
    addBtn.onclick = startCreate;
    addBtn.innerHTML = `<div class="add-icon">Ôºã</div><div style="font-size:0.85rem;font-weight:500;">Create New Deck</div>`;
    grid.appendChild(addBtn);
  }

  function deleteDeck(id) {
    if (!confirm('Delete this deck?')) return;
    decks = decks.filter(d => d.id !== id);
    scheduleSave();
    renderDecks();
  }

  // ---- CREATE / EDIT ----
  function startCreate() {
    editingDeckId = null;
    document.getElementById('create-title').textContent = 'Create New Deck';
    document.getElementById('deck-name-input').value = '';
    document.getElementById('cards-list').innerHTML = '';
    addCardField(); addCardField();
    showView('create');
  }

  function editDeck(id) {
    const deck = decks.find(d => d.id === id);
    if (!deck) return;
    editingDeckId = id;
    document.getElementById('create-title').textContent = 'Edit Deck';
    document.getElementById('deck-name-input').value = deck.name;
    document.getElementById('cards-list').innerHTML = '';
    deck.cards.forEach(c => addCardField(c.front, c.back));
    showView('create');
  }

  function addCardField(front = '', back = '') {
    const list = document.getElementById('cards-list');
    const idx = list.children.length + 1;
    const item = document.createElement('div');
    item.className = 'card-item';
    item.innerHTML = `
      <div class="card-num">CARD ${idx}</div>
      <button class="remove-card-btn" onclick="this.parentElement.remove();renumberCards()">‚úï</button>
      <div class="card-fields">
        <div class="field-group" style="margin:0">
          <label>Front (Term)</label>
          <textarea placeholder="Term or question...">${esc(front)}</textarea>
        </div>
        <div class="field-group" style="margin:0">
          <label>Back (Answer)</label>
          <textarea placeholder="Definition or answer...">${esc(back)}</textarea>
        </div>
      </div>`;
    list.appendChild(item);
  }

  function renumberCards() {
    document.querySelectorAll('.card-num').forEach((el, i) => el.textContent = 'CARD ' + (i + 1));
  }

  async function saveDeck() {
    const name = document.getElementById('deck-name-input').value.trim();
    if (!name) { alert('Please enter a deck name.'); return; }

    const items = document.querySelectorAll('#cards-list .card-item');
    const cards = [];
    items.forEach(item => {
      const [front, back] = item.querySelectorAll('textarea');
      if (front.value.trim() || back.value.trim()) cards.push({ front: front.value.trim(), back: back.value.trim() });
    });
    if (cards.length === 0) { alert('Add at least one card.'); return; }

    if (editingDeckId) {
      const deck = decks.find(d => d.id === editingDeckId);
      deck.name = name; deck.cards = cards;
    } else {
      decks.push({ id: uid(), name, cards });
    }

    await saveToCloud();
    showView('decks');
  }

  // ---- STUDY ----
  function studyDeckById(id) {
    studyDeck = decks.find(d => d.id === id);
    if (!studyDeck || studyDeck.cards.length === 0) { alert('This deck has no cards.'); return; }
    studyDeck = { ...studyDeck, cards: shuffle([...studyDeck.cards]) };
    studyIndex = 0; studyCorrect = 0; studyWrong = 0; isFlipped = false;
    showView('study');
    renderStudyCard();
  }

  function renderStudyCard() {
    const content = document.getElementById('study-content');
    const total = studyDeck.cards.length;

    if (studyIndex >= total) {
      const pct = Math.round((studyCorrect / total) * 100);
      content.innerHTML = `
        <div class="results-wrap">
          <div class="results-title">Session Complete! üéâ</div>
          <div class="results-score">${pct}%</div>
          <div class="results-sub">You went through all ${total} cards</div>
          <div class="results-bars">
            <div class="result-pill g">‚úì ${studyCorrect} Correct</div>
            <div class="result-pill r">‚úó ${studyWrong} Incorrect</div>
          </div>
          <button class="btn-primary" onclick="studyDeckById('${studyDeck.id}')" style="margin-right:.75rem">Study Again</button>
          <button class="btn-outline" onclick="showView('decks')">Back to Decks</button>
        </div>`;
      document.getElementById('progress-fill').style.width = '100%';
      document.getElementById('progress-text').textContent = total + ' / ' + total;
      return;
    }

    const card = studyDeck.cards[studyIndex];
    isFlipped = false;
    document.getElementById('progress-fill').style.width = (studyIndex / total * 100) + '%';
    document.getElementById('progress-text').textContent = (studyIndex + 1) + ' / ' + total;

    content.innerHTML = `
      <div class="flashcard-scene">
        <div class="flashcard" id="the-card" onclick="flipCard()">
          <div class="card-face card-front">
            <div class="card-label">Term</div>
            <div class="card-text">${esc(card.front)}</div>
            <div class="flip-hint">Click to reveal answer</div>
          </div>
          <div class="card-face card-back">
            <div class="card-label">Answer</div>
            <div class="card-text">${esc(card.back)}</div>
          </div>
        </div>
      </div>
      <div class="study-controls">
        <button class="ctrl-btn wrong" title="Got it wrong" onclick="markCard(false)">‚úó</button>
        <button class="flip-btn" onclick="flipCard()">Flip Card</button>
        <button class="ctrl-btn correct" title="Got it right" onclick="markCard(true)">‚úì</button>
      </div>`;
  }

  function flipCard() {
    const card = document.getElementById('the-card');
    if (!card) return;
    isFlipped = !isFlipped;
    card.classList.toggle('flipped', isFlipped);
  }

  function markCard(correct) {
    if (correct) studyCorrect++; else studyWrong++;
    studyIndex++;
    renderStudyCard();
  }

  // ---- HELPERS ----
  function uid() { return Math.random().toString(36).slice(2, 10); }
  function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
  function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  // ---- INIT ----
  const savedUser = localStorage.getItem('flashmind_user');
  if (savedUser) { currentUser = savedUser; bootApp(); }
</script>
</body>
</html>
